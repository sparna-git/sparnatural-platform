<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Sparnatural Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @keyframes pulse {
        0% {
          transform: scale(1);
          opacity: 0.6;
        }
        50% {
          transform: scale(1.3);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 0.6;
        }
      }

      .recording #micIcon {
        animation: pulse 1s infinite;
        color: #10b981; /* Tailwind green-500 */
      }

      .loading #micIcon {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <header
      class="bg-green-600 text-white p-4 flex justify-between items-center"
    >
      <h1 class="text-xl font-bold">Sparnatural Platform</h1>
      <nav class="space-x-4">
        <a href="/admin" class="hover:underline"
          ><i class="fas fa-home"></i> Accueil</a
        >
        <a href="/docs" class="hover:underline" target="_blank"
          ><i class="fas fa-file-code"></i> Swagger</a
        >
      </nav>
    </header>
    <div class="max-w-4xl mx-auto p-6 space-y-6">
      <div class="bg-white shadow-md rounded-lg p-6">
        <label for="projectSelect" class="block font-semibold mb-2"
          >Select a Project :</label
        >
        <select
          id="projectSelect"
          onchange="updateProject()"
          class="w-full p-2 border rounded-md"
        ></select>
        <div id="warning" class="text-red-600 text-sm font-medium mt-2"></div>
      </div>

      <!-- Bloc Langage naturel -> JSON -->
      <div class="bg-white shadow-md rounded-lg p-6 relative">
        <h2 class="text-xl font-semibold mb-4">Natural language to JSON</h2>

        <!-- Container relatif pour textarea + bouton -->
        <div class="relative">
          <textarea
            id="naturalPrompt"
            class="w-full p-2 border rounded-md mb-2 pr-12"
            placeholder="Enter your natural language query here or use voice input"
          ></textarea>

          <button
            id="btnVoice"
            onclick="startVoiceToQuery()"
            class="absolute top-2 right-0 text-black px-3 py-1 rounded-md hover:text-gray-600 flex items-center space-x-1"
          >
            <i id="micIcon" class="fas fa-microphone"></i>
          </button>
        </div>

        <button
          id="btnText2Query"
          onclick="sendText2Query()"
          class="w-full bg-green-600 text-white py-2 mt-2 rounded-md hover:bg-green-700"
        >
          Send
        </button>

        <div class="relative mt-4">
          <pre
            id="naturalResult"
            class="bg-green-50 p-4 rounded text-sm whitespace-pre-wrap"
          ></pre>
          <button
            onclick="copyToClipboard('naturalResult')"
            class="absolute top-[2px] right-[5px] text-gray-600 hover:text-black text-l"
          >
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>

      <!-- Bloc JSON -> R√©sum√© -->
      <div class="bg-white shadow-md rounded-lg p-6 relative">
        <h2 class="text-xl font-semibold mb-4">JSON to Summary</h2>
        <textarea
          id="jsonQuery"
          placeholder="Paste JSON query here"
          class="w-full p-2 border rounded-md mb-2"
        ></textarea>
        <input
          type="text"
          id="lang2"
          value="fr"
          placeholder="Langue (ex: fr)"
          class="w-full p-2 border rounded-md mb-2"
        />
        <button
          id="btnQuery2Text"
          onclick="sendQuery2Text()"
          class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700"
        >
          Send
        </button>

        <div class="relative mt-4">
          <pre
            id="jsonResult"
            class="bg-green-50 p-4 rounded text-sm whitespace-pre-wrap"
          ></pre>
          <button
            onclick="copyToClipboard('jsonResult')"
            class="absolute top-[2px] right-[5px] text-gray-600 hover:text-black text-l"
          >
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Popup de confirmation -->
    <div
      id="copyPopup"
      class="fixed bottom-4 right-4 bg-black bg-opacity-75 text-white py-2 px-4 rounded shadow-lg opacity-0 pointer-events-none transition-opacity duration-300"
    >
      Copy to clipboard!
    </div>

    <script>
      let config = {};
      let selectedProject = "";

      async function loadProjectList() {
        try {
          const res = await fetch("/config");
          const json = await res.json();
          config = json.projects;

          const select = document.getElementById("projectSelect");
          select.innerHTML = "";

          Object.keys(config).forEach((projectKey) => {
            const opt = document.createElement("option");
            opt.value = projectKey;
            opt.text = projectKey;
            select.appendChild(opt);
          });

          selectedProject = select.value;
          updateProject();
        } catch (err) {
          console.error("Erreur chargement config.yaml :", err);
          document.getElementById("warning").textContent =
            "‚ùå Erreur de chargement de la configuration.";
        }
      }

      function updateProject() {
        selectedProject = document.getElementById("projectSelect").value;
        const agents = config[selectedProject]["endpoints-agents"];

        const disabled =
          !agents ||
          !agents.MISTRAL_AGENT_ID_query_2_text ||
          !agents.MISTRAL_AGENT_ID_text_2_query ||
          agents.MISTRAL_AGENT_ID_query_2_text === "coming-soon" ||
          agents.MISTRAL_AGENT_ID_text_2_query === "coming-soon";

        document.getElementById("btnText2Query").disabled = disabled;
        document.getElementById("btnQuery2Text").disabled = disabled;
        document.getElementById("btnVoice").disabled = disabled; // ‚úÖ <-- ligne ajout√©e

        const warning = document.getElementById("warning");
        if (disabled) {
          warning.textContent =
            "‚ö†Ô∏è Les agents pour ce projet ne sont pas encore configur√©s.";
        } else {
          warning.textContent = "";
        }

        document.getElementById("naturalResult").textContent = "";
        document.getElementById("jsonResult").textContent = "";
      }

      async function sendText2Query() {
        const prompt = document.getElementById("naturalPrompt").value.trim();
        if (!prompt) return;

        try {
          const res = await fetch(
            `/${selectedProject}/api/v1/text2query?prompt=${encodeURIComponent(
              prompt
            )}`
          );
          const json = await res.json();
          document.getElementById("naturalResult").textContent = JSON.stringify(
            json,
            null,
            2
          );
        } catch (err) {
          document.getElementById("naturalResult").textContent =
            "‚ùå Erreur lors de l'appel √† l'API.";
        }
      }

      async function sendQuery2Text() {
        const query = document.getElementById("jsonQuery").value.trim();
        const lang = document.getElementById("lang2").value;
        if (!query) return;

        try {
          const res = await fetch(
            `/${selectedProject}/api/v1/query2text?query=${encodeURIComponent(
              query
            )}&lang=${lang}`
          );
          const json = await res.json();
          document.getElementById("jsonResult").textContent =
            json.text || JSON.stringify(json, null, 2);
        } catch (err) {
          document.getElementById("jsonResult").textContent =
            "‚ùå Erreur lors de l'appel √† l'API.";
        }
      }

      function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        if (!text) return;

        navigator.clipboard.writeText(text).then(() => {
          const popup = document.getElementById("copyPopup");
          popup.classList.remove("opacity-0", "pointer-events-none");
          setTimeout(() => {
            popup.classList.add("opacity-0", "pointer-events-none");
          }, 2000);
        });
      }

      loadProjectList();
    </script>
    <script src="/voice.js"></script>
    <script>
      let recognition = null;
      let isRecording = false;

      async function startVoiceToQuery() {
        const btn = document.getElementById("btnVoice");
        const icon = document.getElementById("micIcon");
        const resultBox = document.getElementById("naturalResult");

        if (!("webkitSpeechRecognition" in window)) {
          alert(
            "üö´ La reconnaissance vocale n'est pas support√©e sur ce navigateur."
          );
          return;
        }

        // Si d√©j√† en cours d'enregistrement, stoppe
        if (isRecording) {
          recognition.stop();
          return;
        }

        recognition = new webkitSpeechRecognition();
        recognition.lang = "fr-FR";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        isRecording = true;
        btn.classList.add("recording");

        recognition.start();

        recognition.onresult = async (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById("naturalPrompt").value = transcript;

          btn.classList.remove("recording");
          btn.classList.add("loading");
          icon.className = "fas fa-spinner";
          isRecording = false;

          try {
            const lang = document.getElementById("lang2").value;
            const url = `https://services.sparnatural.eu/dbpedia-en/api/v1/text2query?prompt=${encodeURIComponent(
              transcript
            )}&lang=${encodeURIComponent(lang)}`;

            const res = await fetch(url);
            const json = await res.json();

            resultBox.textContent = JSON.stringify(json, null, 2);

            const sparnaturalEl = document.querySelector("spar-natural");
            if (sparnaturalEl?.loadQuery) sparnaturalEl.loadQuery(json);
          } catch (err) {
            resultBox.textContent = "‚ùå Erreur lors de l'appel √† l'API.";
            console.error(err);
          } finally {
            resetVoiceButtonUI();
          }
        };

        recognition.onerror = (event) => {
          console.error("Erreur de reconnaissance vocale :", event);
          alert("Erreur pendant la reconnaissance vocale.");
          resetVoiceButtonUI();
        };

        recognition.onend = () => {
          if (isRecording) {
            resetVoiceButtonUI();
          }
        };

        function resetVoiceButtonUI() {
          isRecording = false;
          btn.classList.remove("recording", "loading");
          icon.className = "fas fa-microphone";
        }
      }
    </script>
  </body>
</html>
